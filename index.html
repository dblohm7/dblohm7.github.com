
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Aaron Klotz at Mozilla</title>
  <meta name="author" content="Aaron Klotz">

  
  <meta name="description" content="Today I decided to diff the export tables of some core Win32 DLLs to see what&rsquo;s
changed between Windows 8.1 and the Windows 10 technical &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://dblohm7.ca">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Aaron Klotz at Mozilla" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  
<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-36293908-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <link href="http://static.teamohms.org/img/favicon.gif" rel="icon">
</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Aaron Klotz at Mozilla</a></h1>
  
    <h2>My adventures as a member of Mozilla&#8217;s Desktop Performance Team</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:dblohm7.ca" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/28/interesting-win32-apis/">Interesting Win32 APIs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-07-28T11:30:00-06:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2015/07/28/interesting-win32-apis/#disqus_thread"
             data-disqus-identifier="http://dblohm7.ca/blog/2015/07/28/interesting-win32-apis/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today I decided to diff the export tables of some core Win32 DLLs to see what&rsquo;s
changed between Windows 8.1 and the Windows 10 technical preview. There weren&rsquo;t
many changes, but the ones that were there are quite exciting IMHO. While
researching these new APIs, I also stumbled across some others that were
added during the Windows 8 timeframe that we should be considering as well.</p>

<h2>Volatile Ranges</h2>

<p>While my diff showed these APIs as new exports for Windows 10, the MSDN docs
claim that these APIS are actually new for the Windows 8.1 Update. Using the
<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dn781436%28v=vs.85%29.aspx"><code>OfferVirtualMemory</code></a>
and <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dn781437%28v=vs.85%29.aspx"><code>ReclaimVirtualMemory</code></a>
functions, we can now specify ranges of virtual memory that are safe to
discarded under memory pressure. Later on, should we request that access be
restored to that memory, the kernel will either return that virtual memory to us
unmodified, or advise us that the associated frames have been discarded.</p>

<p>A couple of years ago we had an intern on the Perf Team who was working on
bringing this capability to Linux. I am pleasantly surprised that this is now
offered on Windows.</p>

<h2><code>madvise(MADV_WILLNEED)</code> for Win32</h2>

<p>For the longest time we have been hacking around the absence of a <code>madvise</code>-like
API on Win32. On Linux we will do a <code>madvise(MADV_WILLNEED)</code> on memory-mapped
files when we want the kernel to read ahead. On Win32, we were opening the
backing file and then doing a series of sequential reads through the file to
force the kernel to cache the file data. As of Windows 8, we can now call
<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/hh780543%28v=vs.85%29.aspx"><code>PrefetchVirtualMemory</code></a>
for a similar effect.</p>

<h2>Operation Recorder: An API for SuperFetch</h2>

<p>The <a href="https://msdn.microsoft.com/en-us/library/hh437562%28v=vs.85%29.aspx"><code>OperationStart</code></a>
and <a href="https://msdn.microsoft.com/en-us/library/hh437558%28v=vs.85%29.aspx"><code>OperationEnd</code></a>
APIs are intended to record access patterns during a file I/O operation.
SuperFetch will then create prefetch files for the operation, enabling prefetch
capabilities above and beyond the use case of initial process startup.</p>

<h2>Memory Pressure Notifications</h2>

<p>This API is not actually new, but I couldn&rsquo;t find any invocations of it in the
Mozilla codebase. <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa366541%28v=vs.85%29.aspx"><code>CreateMemoryResourceNotification</code></a>
allocates a kernel handle that becomes signalled when physical memory is running
low. Gecko already has facilities for handling memory pressure events on other
platforms, so we should probably add this to the Win32 port.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/12/waitmessage-considered-harmful/">WaitMessage Considered Harmful</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-12T15:00:00-06:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2015/03/12/waitmessage-considered-harmful/#disqus_thread"
             data-disqus-identifier="http://dblohm7.ca/blog/2015/03/12/waitmessage-considered-harmful/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I could apologize for the clickbaity title, but I won&rsquo;t. I have no shame.</p>

<p>Today I want to talk about some code that we imported from Chromium some time
ago. I replaced it in Mozilla&rsquo;s codebase a few months back in <a title="IPC message pump for windows should use WinUtils::WaitForMessage" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1072752">bug 1072752</a>:</p>

<figure class='code'><figcaption><span> (message_pump_win.cc)</span> <a href='/downloads/code/message_pump_win.cc'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="c1">// A WM_* message is available.</span>
</span><span class='line'>    <span class="c1">// If a parent child relationship exists between windows across threads</span>
</span><span class='line'>    <span class="c1">// then their thread inputs are implicitly attached.</span>
</span><span class='line'>    <span class="c1">// This causes the MsgWaitForMultipleObjectsEx API to return indicating</span>
</span><span class='line'>    <span class="c1">// that messages are ready for processing (Specifically, mouse messages</span>
</span><span class='line'>    <span class="c1">// intended for the child window may appear if the child window has</span>
</span><span class='line'>    <span class="c1">// capture).</span>
</span><span class='line'>    <span class="c1">// The subsequent PeekMessages call may fail to return any messages thus</span>
</span><span class='line'>    <span class="c1">// causing us to enter a tight loop at times.</span>
</span><span class='line'>    <span class="c1">// The WaitMessage call below is a workaround to give the child window</span>
</span><span class='line'>    <span class="c1">// some time to process its input messages.</span>
</span><span class='line'>    <span class="n">MSG</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span><span class='line'>    <span class="n">DWORD</span> <span class="n">queue_status</span> <span class="o">=</span> <span class="n">GetQueueStatus</span><span class="p">(</span><span class="n">QS_MOUSE</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">HIWORD</span><span class="p">(</span><span class="n">queue_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">QS_MOUSE</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>        <span class="o">!</span><span class="n">PeekMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">WM_MOUSEFIRST</span><span class="p">,</span> <span class="n">WM_MOUSELAST</span><span class="p">,</span> <span class="n">PM_NOREMOVE</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">WaitMessage</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code is wrong. <strong>Very</strong> wrong.</p>

<p>Let us start with the calls to <code>GetQueueStatus</code> and <code>PeekMessage</code>. Those APIs
mark any messages already in the thread&rsquo;s message queue as having been seen,
such that they are no longer considered &ldquo;new.&rdquo; Even though those function calls
do not remove messages from the queue, any messages that were in the queue at
this point are considered to be &ldquo;old.&rdquo;</p>

<p>The logic in this code snippet is essentially saying, &ldquo;if the queue contains
mouse messages that do not belong to this thread, then they must belong to an
attached thread.&rdquo; The code then calls <code>WaitMessage</code> in an effort to give the
other thread(s) a chance to process their mouse messages. This is where the code
goes off the rails.</p>

<p>The <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms644956%28v=vs.85%29.aspx">documentation</a>
for <code>WaitMessage</code> states the following:</p>

<blockquote><p>Note that <code>WaitMessage</code> does not return if there is unread input in the message
queue after the thread has called a function to check the queue. This is
because functions such as <code>PeekMessage</code>, <code>GetMessage</code>, <code>GetQueueStatus</code>,
<code>WaitMessage</code>, <code>MsgWaitForMultipleObjects</code>, and <code>MsgWaitForMultipleObjectsEx</code>
check the queue and then change the state information for the queue so that
the input is no longer considered new. A subsequent call to <code>WaitMessage</code> will
not return until new input of the specified type arrives. The existing unread
input (received prior to the last time the thread checked the queue) is ignored.</p></blockquote>

<p><code>WaitMessage</code> will only return if there is <em>a new</em> (as opposed to <em>any</em>) message
in the queue for the calling thread. Any messages for the calling thread that
were already in there at the time of the <code>GetQueueStatus</code> and <code>PeekMessage</code> calls
are no longer new, so they are ignored.</p>

<p>There might very well be a message at the head of that queue that should be
processed by the current thread. Instead it is ignored while we wait for other
threads. Here is the crux of the problem: we&rsquo;re waiting on other threads whose
input queues are attached to our own! That other thread can&rsquo;t process its
messages because our thread has messages in front of its messages; on the other
hand, our thread has blocked itself!</p>

<p>The only way to break this deadlock is for new messages to be added to the queue.
That is a big reason why we&rsquo;re seeing things like <a title="Page doesn't load/render if the mouse is not moving" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1105386">bug 1105386</a>: Moving the
mouse adds new messages to the queue, making <code>WaitMessage</code> unblock.</p>

<p>I&rsquo;ve already eliminated this code in Mozilla&rsquo;s codebase, but the challenge is
going to be getting rid of this code in third-party binaries that attach their
own windows to Firefox&rsquo;s windows.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/03/attached-input-queues-on-firefox-for-windows/">Attached Input Queues on Firefox for Windows</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-03T17:28:06-07:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2015/03/03/attached-input-queues-on-firefox-for-windows/#disqus_thread"
             data-disqus-identifier="http://dblohm7.ca/blog/2015/03/03/attached-input-queues-on-firefox-for-windows/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve <a href="http://dblohm7.ca/blog/2012/11/22/plugin-hang-user-interface-for-firefox/">previously</a> <a href="http://dblohm7.ca/blog/2013/02/15/plugin-hang-ui-on-aurora/">blogged</a>
indirectly about attached input queues, but today I want to address the issue directly. What once was a nuisance in the realm of plugin hangs has grown into a more
serious problem in the land of OMTC and e10s.</p>

<p>As a brief recap for those who are not very familiar with this problem: imagine two windows, each on their own separate threads, forming a parent-child relationship
with each other. When this situation arises, Windows implicitly attaches together and synchronizes their input queues, putting each thread at the mercy of the other
attached threads&#8217; ability to pump messages. If one thread does something bad in its message pump, any other threads that are attached to it are likely to be affected as well.</p>

<p>One of the biggest annoyances when it comes to knowledge about which threads are affected, is that we are essentially flying blind. There is no
way to query Windows for information about attached input queues. This is unfortunate, as it would be really nice to obtain some specific knowledge to allow us to
analyze the state of Firefox threads&#8217; input queues so that we can mitigate the problem.</p>

<p>I had previously been working on a personal side project to make this possible, but in light of recent developments (and a <a href="https://twitter.com/nsIAnswers/status/565883284748795905">tweet from bsmedberg</a>),
I decided to bring this investigation under the umbrella of my full-time job. I&rsquo;m pleased to announce that I&rsquo;ve finished the first cut of a utility that I call
the Input Queue Visualizer, or <code>iqvis</code>.</p>

<p><code>iqvis</code> consists of two components, one of which is a kernel-mode driver. This driver exposes input queue attachment data to user mode. The <code>iqvis</code> user-mode
executable is the client that queries the driver and outputs the results. In the next section I&rsquo;m going to discuss the inner workings of <code>iqvis</code>. Following that, I&rsquo;ll
discuss the <a href="#results">results</a> of running <code>iqvis</code> on an instance of Firefox.</p>

<h2><a name="internals"></a>Input Queue Visualizer Internals</h2>

<p>First of all, let&rsquo;s start off with this caveat: <strong>Nearly everything that this driver does involves undocumented APIs and data structures</strong>. Because of this, <code>iqvis</code>
does some things that you should never do in production software.</p>

<p>One of the big consequences of using undocumented information is that <code>iqvis</code> requires pointers to very specific locations
in kernel memory to accomplish things. These pointers will change every time that Windows is updated. To mitigate this, I kind of cheated: it turns out that
debugging symbols exist for all of the locations that <code>iqvis</code> needs to access! I wrote the <code>iqvis</code> client to invoke the <code>dbghelp</code> engine to extract the pointers that
I need from Windows symbols and send those values as the input to the <code>DeviceIoControl</code> call that triggers the data collection. Passing pointers from user mode to be
accessed in kernel mode is a very dangerous thing to do (and again, I would never do it in production software), but it is damn convenient for <code>iqvis</code>!</p>

<p>Another issue is that these undocumented details change between Windows versions. The initial version of <code>iqvis</code> works on 64-bit Windows 8.1, but different code is required
for other major releases, such as Windows 7. The <code>iqvis</code> driver theoretically will work on Windows 7 but I need to make a few bug fixes for that case.</p>

<p>So, getting those details out of the way, we can address the crux of the problem: we need to query input queue attachment information from <code>win32k.sys</code>, which is the
driver that implements USER and GDI system calls on Windows NT systems.</p>

<p>In particular, the window manager maintains a linked list that describes thread attachment info as a triple that points to the &ldquo;from&rdquo; thread, the &ldquo;to&rdquo; thread, and a count.
The count is necessary because the same two threads may be attached to each other multiple times. The <code>iqvis</code> driver walks this linked list in a thread-safe way to obtain
the attachment data, and then copies it to the output buffer for the <code>DeviceIoControl</code> request.</p>

<p>Since <code>iqvis</code> involves a device driver, and since I have not digitally signed that device driver, one can&rsquo;t just run <code>iqvis</code> and call it a day. This program won&rsquo;t work
unless the computer was either booted with kernel debugging enabled, or it was booted with driver signing temporarily disabled.</p>

<h2><a name="results"></a>Running <code>iqvis</code> against Firefox</h2>

<p>Today I ran <code>iqvis</code> using today&rsquo;s Nightly 39 as well as the lastest release of Flash. I also tried it with Flash Protected Mode both disabled and enabled.
(Note that these examples used an older version of <code>iqvis</code> that outputs thread IDs in hexadecimal. The current version uses decimal for its output.)</p>

<h3>Protected Mode Disabled</h3>

<pre><samp>FromTID ToTID Count
ac8 df4 1
</samp></pre>


<p>Looking up the thread IDs:</p>

<ul>
<li><code>df4</code> is the Firefox main thread;</li>
<li><code>ac8</code> is the plugin-container main thread.</li>
</ul>


<p>I think that the output from this case is pretty much what I was expecting to see. The protected mode case, however, is more interesting.</p>

<h3>Protected Mode Enabled</h3>

<pre><samp>FromTID ToTID Count
f8c dbc 1
794 f8c 3
</samp></pre>


<p>Looking up the thread IDs:</p>

<ul>
<li><code>dbc</code> is the Firefox main thread;</li>
<li><code>f8c</code> is the plugin-container main thread;</li>
<li><code>794</code> is the Flash sandbox main thread.</li>
</ul>


<p>Notice how Flash is attached to plugin-container, which is then attached to Firefox. Notice that transitively the Flash sandbox is effectively attached to Firefox,
confirming previous hypotheses that I&rsquo;ve discussed with colleagues in the past.</p>

<p>Also notice how the Flash sandbox attachment to plugin-container has a count of 3!</p>

<h2>In Conclusion</h2>

<p>In my opinion, my Input Queue Visualizer has already yielded some very interesting data. Hopefully this will help us to troubleshoot our issues in the future. Oh,
and the code is up on <a href="https://github.com/dblohm7/iqvis">GitHub</a>! It&rsquo;s poorly documented at the moment, but just remember to only try running it on 64-bit Windows
8.1 for the time being!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/31/asynchronous-plugin-initialization-nightly/">Asynchronous Plugin Initialization: Nightly</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-31T12:00:00-07:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2014/12/31/asynchronous-plugin-initialization-nightly/#disqus_thread"
             data-disqus-identifier="http://dblohm7.ca/blog/2014/12/31/asynchronous-plugin-initialization-nightly/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As of today&rsquo;s <a href="http://nightly.mozilla.org">Nightly</a>, Asynchronous Plugin
Initialization is available for testing. It is deactivated by default, so in
order to try it out you will need to navigate to <code>about:config</code> and toggle the
<code>dom.ipc.plugins.asyncInit</code> preference to <code>true</code>.</p>

<p>If you experience any problems, please <a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Core&amp;component=Plug-ins&amp;blocked=1116806">file a bug</a> that blocks <a title="Let Asynchronous Plugin Initialization ride the train" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1116806">bug 1116806</a>.</p>

<p>Happy New Year!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/21/profile-unlocking-in-firefox-34-for-windows/">Profile Unlocking in Firefox 34 for Windows</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-21T10:00:00-06:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2014/08/21/profile-unlocking-in-firefox-34-for-windows/#disqus_thread"
             data-disqus-identifier="http://dblohm7.ca/blog/2014/08/21/profile-unlocking-in-firefox-34-for-windows/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today&rsquo;s <a href="http://nightly.mozilla.org">Nightly 34</a> build includes the work I did
for <a title="Need win32 implementation of nsIProfileUnlocker" href="https://bugzilla.mozilla.org/show_bug.cgi?id=286355">bug 286355</a>: a profile unlocker for our Windows users. This should be very
helpful to those users whose workflow is interrupted by a Firefox instance that
cannot start because a previous Firefox instance has not finished shutting down.</p>

<p>Firefox 34 users running Windows Vista or newer will now be presented with this
dialog box:</p>

<p><a href="http://dblohm7.ca/images/profile-unlocker.png"><img src="http://dblohm7.ca/images/profile-unlocker.png"></a></p>

<p>Clicking &ldquo;Close Firefox&rdquo; will terminate that previous instance and proceed
with starting your new Firefox instance.</p>

<p>Unfortunately this feature is not available to Windows XP users. To support this
feature on Windows XP we would need to call undocumented API functions. I
prefer to avoid calling undocumented APIs when writing production software due
to the potential stability and compatibility issues that can arise from doing
so.</p>

<p>While this feature adds some convenience to an otherwise annoying issue, please
be assured that the Desktop Performance Team will continue to investigate and
fix the root causes of long shutdowns so that a profile unlocker hopefully
becomes unnecessary.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/14/diffusion-of-responsibility/">Diffusion of Responsibility</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-14T14:00:00-06:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2014/08/14/diffusion-of-responsibility/#disqus_thread"
             data-disqus-identifier="http://dblohm7.ca/blog/2014/08/14/diffusion-of-responsibility/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Something that I&rsquo;ve been noticing on numerous social media and discussion forum
sites is that whenever Firefox comes up, inevitably there are comments in those
threads about Firefox performance. Given my role at Mozilla, these comments are
of particular interest to me.</p>

<p>The reaction to roc&rsquo;s <a href="http://robert.ocallahan.org/2014/08/choose-firefox-now-or-later-you-wont.html">recent blog post</a>
has motivated me enough to respond to a specific subset of comments. These
comments all exhibit a certain pattern: their authors are experiencing problems
with Firefox, they are very dissatisfied, but they are not discussing them in a
way that is actionable by Mozilla.</p>

<h2>How Mozilla Finds Problems</h2>

<p>Mozilla encourages our contributors to run prerelease versions of Firefox,
especially <a href="http://nightly.mozilla.org">Nightly</a> builds. This allows us to do
some good old-fashioned dogfooding during the development of a Firefox release.</p>

<p>We also have many tools that run as part of our continuous integration
infrastructure. Valgrind, Address Sanitizer, Leak Sanitizer, reference count
tracking, deadlock detection, assertions, Talos performance tests, and xperf are
some of the various tools that we apply to our builds. I do not claim that this
list is exhaustive! :-)</p>

<p>We use numerous technologies to discover problems that occur while running on
our users&#8217; computers. We have a crash reporter that (with the user&rsquo;s consent)
reports <a href="https://crash-stats.mozilla.com/home/products/Firefox">data</a> about the
crash. We have Firefox Health Report and <a href="http://telemetry.mozilla.org">Telemetry</a>
that, when consented to, send us useful information for discovering problems.</p>

<p>Our ability to analyze crash report/FHR/telemetry data is limited to those users
who consent to share it with us. As much as I am proud of the fact that we
respect the privacy of our users, this means that we only receive data from a
fraction of them; many users who are experiencing problems are not included in
this data.</p>

<p>Despite the fact that we have all of these wonderful tools to help us deliver
quality releases, the fact is that they cannot exhaustively catch every possible
bug that is encountered out in the wild. There are too many combinations of
extensions and configurations out there to possibly allow us to catch
everything before release.</p>

<p>That&rsquo;s where you, our users, come in!</p>

<h2>If You See Something, Report It!</h2>

<p>Reddit, Hacker News, Slashdot and other similar sites are fantastic for ranting.
I should know &ndash; I do it with the best of them! Having said that, they are also
terrible for the purposes of bug reporting!</p>

<p>As users it&rsquo;s easy for us to assume that somebody else will encounter our
problems and report them. Unfortunately that is not always the case, especially
with a browser that is as configurable as Firefox.</p>

<h3>Reporting Bugs</h3>

<p>If you are experiencing a bug, the best way to ensure that something can be done
about your bug is to <a href="https://bugzilla.mozilla.org/enter_bug.cgi?format=guided">report it</a>
in Bugzilla. This might seem a little bit intimidating for somebody who is new
to bug reporting, but I assure you, Mozillians are really nice! As long as you
follow the <a href="https://bugzilla.mozilla.org/page.cgi?id=etiquette.html">etiquette guidelines</a>,
you&rsquo;ll be fine! One suggestion though: try to follow our
<a href="https://developer.mozilla.org/en-US/docs/Mozilla/QA/Bug_writing_guidelines">bug writing guidelines</a>.
Doing so will maximize the likelihood of a contributor being able to reproduce
your problem. In addition to these suggestions for bug filing, I also suggest
including certain types of data for specific types of problems:</p>

<h3>Reporting a Bug for High Memory Usage</h3>

<p>If you&rsquo;re experiencing problems with Firefox&rsquo;s memory use, open a tab, and
point your browser to <code>about:memory</code>. This nifty feature provides a breakdown
of Firefox memory consumption. Save that report and attach it to the bug that
you&rsquo;ve filed.</p>

<h3>Reporting a Bug for Slowness or Heavy CPU Usage</h3>

<p>If you want report a problem with Firefox being slow and/or mysteriously
consuming large amounts of CPU time, the best way to help us is
is to include data that has been generated by the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Performance/Profiling_with_the_Built-in_Profiler">Gecko Profiler</a>.
[<em>This data is referred to as a &ldquo;profile,&rdquo; but please do not confuse it with the
user profile that stores your settings and browser history &ndash; they are different
things with the same name.</em>] This tool tracks how Firefox uses your CPU over
time. If you are able to attach a profile that was taken during a period of time
where Firefox was running poorly, it will help us understand what exactly Firefox
was doing. Unfortunately this is tool requires a bit of technical savvy, but
attaching the URL of an uploaded profile to your performance bug can be very helpful.</p>

<h3>Reporting a Bug for a Persistent, Reproducable Crash</h3>

<p>As you can see in our <a href="https://crash-stats.mozilla.com/home/products/Firefox">crash report data</a>,
crashes reported to Mozilla are ranked by frequency. As you might expect, this
implies that it&rsquo;s often the squeaky wheels that get the grease.</p>

<p>If you have an easily reproducable crash and you are sending your reports to
Mozilla, you can help us by pointing Firefox to <code>about:crashes</code>. This page lists
all of the crash reports that have been generated on your computer. If the crash
that you are experiencing isn&rsquo;t on our list of top crashers, you can still help
us to fix it: filing a bug that includes multiple crash report URLs from your
<code>about:crashes</code> screen will help tremendously.</p>

<h3>Reporting a Bug for a Website that Looks Wrong in Firefox</h3>

<p>I&rsquo;d suggest reporting your problem over at <a href="http://webcompat.com">webcompat.com</a>.
Volunteers will review your report and determine whether your problem is caused
by the website or by Firefox, and file a bug with the appropriate entity.</p>

<h3>I have a problem that isn&rsquo;t listed here. What should I do?</h3>

<p>Send us <a href="https://input.mozilla.org/en-US/feedback">feedback</a>!</p>

<h2>In Conclusion</h2>

<p>If there is one idea that you can take away from this post (a TL;DR, if you will),
it is this: <em>Mozilla cannot fix 100% of the bugs that we do not know about.</em></p>

<p>Taking an active role in the Mozilla community by reporting your issues through
the proper channels is the best way to ensure that your problems can be fixed.</p>

<p><strong>EDIT:</strong> To be clear: What I am suggesting is that users who are enthusiastic
enough to post a comment to Hacker News (for example) should also be savvy
enough to be able to file a proper bug report. Please do not misconstrue this
post as a demand that novice users start filing bugs.</p>

<p><strong>EDIT August 15, 2014:</strong> Nick Nethercote just <a href="https://blog.mozilla.org/nnethercote/2014/08/15/the-story-of-a-tricky-bug/">blogged</a>
about a tricky memory bug that couldn&rsquo;t have been diagnosed without the help of
a Redditor whose complaint we steered to Bugzilla.</p>

<p><strong>EDIT August 23, 2014:</strong> Wow, this has blown up. More edits to update this post
with additional information in repose to some of the questions posted in the
comments. Thanks for reading!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/17/asynchronous-plugin-initialization-an-introduction/">Asynchronous Plugin Initialization: An Introduction</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-17T02:30:00-06:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2014/06/17/asynchronous-plugin-initialization-an-introduction/#disqus_thread"
             data-disqus-identifier="http://dblohm7.ca/blog/2014/06/17/asynchronous-plugin-initialization-an-introduction/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have spent a lot of time this quarter working on <a title="Asynchronous Initialization of Out-of-process Plugins" href="https://bugzilla.mozilla.org/show_bug.cgi?id=998863">bug 998863</a>, &ldquo;Asynchronous
Initialization of Out-of-process Plugins.&rdquo; While the bug summary is fairly self
explanatory, I would like to provide some more details about why I am doing this
and what kind of work it entails. I would also like to wrap up the post with an
early demonstration of this feature and present some profiles to illustrate the
potential performance improvement.</p>

<h2>Rationale</h2>

<p>The reason that I am undertaking this project is because NPAPI plugin startup
is our most frequent cause of jank. In fact, at the time of this writing, our
<a href="http://telemetry.mozilla.org/chromehangs/">Chrome Hangs telemetry</a> is showing
that 4 out of our top 10 most frequent offending call stacks are related to
plugin initialization and instantiation. Furthermore, creating the
plugin-container.exe child process is the #1 most frequent chrome hang offender
(Note that our Chrome Hang telemetry consists entirely of Windows builds, where
process creation is quite expensive).</p>

<h2>A High-level Breakdown of NPAPI Initialization and Instantiation</h2>

<p>The typical steps involved can be broken down as follows:</p>

<ol>
<li>Launch the <code>plugin-container</code> process;</li>
<li>Call <code>NP_Initialize</code> to load the plugin;</li>
<li>Create instances by calling <code>NPP_New</code>;</li>
<li>Call <code>NPP_NewStream</code> for instances that load stream data;</li>
<li>If an instance is scriptable, call <code>NPP_GetValue</code> to obtain information
about the plugin&rsquo;s scriptable object.</li>
</ol>


<p>The patch that I am working on modifies steps 1 through 4 to run asynchronously.
Step 5 is a special case &ndash; we asynchronously return a proxy object, but if a
synchronous JS method is called on that object, we must wait for the plugin to
initialize (if it has not yet done so). My hope is that if we have to call a
synchronous JS method on the proxy object, plugin initialization will be far
enough along that the wait will be minimal.</p>

<h2>A Brief Demonstration</h2>

<p>The following video compares two locally-built Nightlies that are identical
except for the asynchronous initialization patch. After loading the browser
with a page containing several embedded Flash objects, we can profile and
observe the effects of this patch.</p>

<iframe width="420" height="315" src="//www.youtube-nocookie.com/embed/HZ8Z2Drv8uI?rel-0" frameborder="0" allowfullscreen></iframe>


<p>Here are links to some profiles:</p>

<p><a href="http://people.mozilla.org/~bgirard/cleopatra/#report=a5a96119742fa75b64ab7d12566eede68468ef3c">Synchronous Plugin Initialization</a></p>

<p><a href="http://people.mozilla.org/~bgirard/cleopatra/#report=282e372d3357316307c182607f26c00f4f41011e">Asynchronous Plugin Initialization</a></p>

<h2>Disclaimer</h2>

<p>This patch requires some further work on scripting and stabilization. The
information in this post is subject to change. :-)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/12/detecting-main-thread-i-slash-o-with-sps/">Detecting Main Thread I/O With SPS</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-12T18:00:00-06:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2013/06/12/detecting-main-thread-i-slash-o-with-sps/#disqus_thread"
             data-disqus-identifier="http://dblohm7.ca/blog/2013/06/12/detecting-main-thread-i-slash-o-with-sps/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=867762">bug 867762</a> I am landing I/O
interpose facilities for SPS. This feature will allow main thread I/O to be
displayed in the profiler UI.</p>

<p>There are a few components to this patch. Classes that implement the
<code>IOInterposerModule</code> interface are responsible for hooking into an arbitrary I/O
facility and calling into <code>IOInterposer</code> with those events.</p>

<p>The <code>IOInterposer</code> receives those events and then dispatches them to any registered
observers. For the purposes of SPS there is only one observer,
<code>ProfilerIOInterposeObserver</code>, however I wrote this keeping in mind that we
may eventually want to use the I/O interpose facilities for other purposes (such
as shutdown write poisioning).</p>

<p>For bug 867762 I have implemented two modules. <code>NSPRInterposer</code> hooks into NSPR
file I/O and generates events whenever a <code>PR_Read</code>, <code>PR_Write</code>, or <code>PR_Sync</code> occurs.
The second module, <code>SQLiteInterposer</code>, leverages the SQLite VFS that we use for
telemetry to tap into reads, writes, and fsyncs generated by SQLite. In the future
we expect to expand this into several additional modules. Some ideas include a module
that uses Event Tracing for Windows to read events from the Windows kernel and a
module that interposes calls to <code>read</code>, <code>write</code>, and <code>fsync</code> on Linux.</p>

<p>On the observer side of things, for now we simply insert a marker into the profiler
timeline whenever main thread I/O is reported. Here is a sample screenshot of the
markers in action (the pink stuff for readers who are unfamiliar with SPS markers):</p>

<p><a href="http://dblohm7.ca/images/iomarkers.png"><img src="http://dblohm7.ca/images/iomarkers.png"></a></p>

<p>In <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=867757">bug 867757</a> (under review)
this will become more sophisticated, as SPS will immediately sample the callstack of
the thread whose I/O has been intercepted. This annotated stack will be inserted
directly into the timeline.</p>

<p>There will need to be some UI changes for this to be presented in a reasonable way,
but with both existing patches applied the data is already useful. By firing up
Cleopatra and filtering on either <code>NSPRInterposer</code> or <code>SQLiteInterposer</code>, you can
isolate and view the main thread I/O stacks:</p>

<p><a href="http://dblohm7.ca/images/iofilteredstacks.png"><img src="http://dblohm7.ca/images/iofilteredstacks.png"></a></p>

<p>Hopefully these patches will prove to be beneficial to our efforts to eliminate
main thread I/O.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/15/plugin-hang-ui-on-aurora/">Plugin Hang UI on Aurora</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-15T17:00:00-07:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2013/02/15/plugin-hang-ui-on-aurora/#disqus_thread"
             data-disqus-identifier="http://dblohm7.ca/blog/2013/02/15/plugin-hang-ui-on-aurora/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>The UI Has Landed</h2>

<p>The <a href="http://dblohm7.ca/blog/2012/11/22/plugin-hang-user-interface-for-firefox/">Plugin Hang UI</a>
landed in mozilla-central in time for January&rsquo;s merge. This means that it is
now available on both Nightly and Aurora.</p>

<p>While it&rsquo;s great that this code is now available to a larger audience, there
are consequences to this. :-)</p>

<h2>Telemetry and Pref Adjustments</h2>

<p>The first (and more pleasant) consequence is that we are now receiving telemetry
about the UI&rsquo;s usage patterns. This allows us to make some adjustments as the
Plugin Hang UI gets closer to the release channel. As happy as I am that this
feature will be putting users in the driver&rsquo;s seat when dealing with hung
plugins, it&rsquo;s also important to not annoy users.</p>

<p>Initially our telemetry suggested that the Plugin Hang UI frequently appeared
but then cancelled automatically because the plugin resumed execution. This
indicated to us that we should increase the default value of the
<code>dom.ipc.plugins.hangUITimeoutSecs</code> preference (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=833560">bug 833560</a>).
There has also been some discussion about scaling the Hang UI threshold depending
on hardware performance and user behaviour. This threshold is tricky to balance;
while we want users to be able to terminate a hanging plugin, we want to provide
that feature with minimal annoyance.</p>

<h2>Crashes</h2>

<p>Another consequence of the feature landing is that we received reports from
Nightly and Aurora showing that the Plugin Hang UI was inducing crashes in the
browser itself. Unfortunately the only thing that the stack traces were telling
us was that the browser-side code that hosts out-of-process plugins was not
being cleaned up properly after forcibly terminating the plugin container. We
didn&rsquo;t have any steps to reproduce. What broke this mystery wide open was when
our crash stats were finally able to show some correlations. I learned that
nearly 50% of the crashes happened on single-core CPUs.</p>

<h3>The Problem</h3>

<p>Once I was able to test this out for myself, the issue revealed itself in short order.
Fortunately for me, even though the problem involved thread scheduling, I was still able
to reproduce it in a debugger. <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=828034#c8">This patch</a>
took care of the problem.</p>

<p>There&rsquo;s a bit of nuance to what was happening with this crash. When
<code>plugin-container.exe</code> is forcibly terminated, cleanup of the browser-facing
plugin code may be executed in one of two different sequences:</p>

<h3>Sequence 1 (Most common)</h3>

<ol>
<li><p>After terminating <code>plugin-container.exe</code>, the Plugin Hang UI posts a
<code>CleanupFromTimeout</code> work item to the main thread. Concurrently on the
I/O thread, Firefox&rsquo;s <code>RPCChannel</code> detects an error and posts a
<code>OnNotifyMaybeChannelError</code> work item.</p></li>
<li><p><code>OnNotifyMaybeChannelError</code> executes and sets the channel&rsquo;s state to
<code>ChannelError</code>. It also cleans up the <code>PluginModuleParent</code> actor and its
actors for subprotocols.</p></li>
<li><p><code>CleanupFromTimeout</code> runs and attempts to Close the channel. This
is effectively a no-op since the channel was already closed with an
error status by step 2.</p></li>
</ol>


<h3>Sequence 2 (Less common unless running on fewer cores)</h3>

<ol>
<li><p>Same as in Sequence 1.</p></li>
<li><p><code>CleanupFromTimeout</code> runs before <code>OnNotifyMaybeChannelError</code>. This
work item attempts to do a regular <code>Close</code> on the channel. Since the
channel&rsquo;s state is still set to <code>ChannelConnected</code>, the close operation
doesn&rsquo;t realize that it needs to do additonal cleanup. It performs
a clean shutdown of the RPC channel without properly cleaning up the
IPDL actors.</p></li>
<li><p><code>OnMaybeNotifyChannelError</code> runs, sees the channel is already closed
due to the activities in step 2, and does nothing.</p></li>
<li><p>A crash later occurs because the actors were never cleaned up properly.</p></li>
</ol>


<h3>Some Additional Analysis</h3>

<p>Sequence 2 cannot crash if the <code>plugin-container.exe</code> process is terminated
by the main thread. This is because <code>PluginModuleParent::ShouldContinueFromReplyTimeout</code>
returns <code>false</code> in this case and the channel&rsquo;s state is set to <code>ChannelTimeout</code> by
the time that the <code>CleanupFromTimeout</code> work item executes. This guarantees that
a full cleanup will be done by <code>CleanupFromTimeout</code>.</p>

<p>With the Plugin Hang UI, <code>plugin-container.exe</code> is not terminated by the main
thread, so the channel&rsquo;s state must be explicitly updated after termination.</p>

<h3>Solution</h3>

<p>The patch modifies the <code>CleanupFromTimeout</code> work item so that if the
plugin container was terminated outside the main thread, the channel is
explicitly closed with an error state. This ensures that the actors are
properly cleaned up.</p>

<h2>Hangs</h2>

<p>I filed <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=834127">bug 834127</a>
when QA discovered that sometimes the Plugin Hang UI was not being displayed.
I found out that Firefox was correctly spawning <code>plugin-hang-ui.exe</code>, however
it was not showing any UI.</p>

<p>This lead be back down the input queue rabbit hole that I briefly discussed
last time. I learned that on an intermittent basis, the Plugin Hang UI dialog
box was being hung up on Win32 <code>ShowWindow</code> and <code>SetFocus</code> calls. What I did
know was that my attempts to explicitly detach the Plugin Hang UI&rsquo;s thread
from the hung Firefox thread weren&rsquo;t working as well as I would have liked.</p>

<p>After <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=834127#c9">numerous attempts</a>
at fixing these issues, I determined that for the time being we will need to
rescind the owner-owned relationship between Firefox and the Plugin Hang UI
dialog. If we didn&rsquo;t do so, seemingly benign actions like calling <code>PeekMessage</code>
or passing a <code>WM_NCLBUTTONDOWN</code> message to <code>DefWindowProc</code> would be enough
to bring the Plugin Hang UI to a halt. Why is this, you ask? I decided to
peek into kernel mode to find out.</p>

<h3>Adventures in Kernel Mode</h3>

<p>Recall that the guts of <code>USER32</code> and <code>GDI32</code> were moved into kernel mode
via <code>win32k.sys</code> in the Windows NT 3.5 timeframe. It follows that any
efforts to examine Win32 internals necessitates peering into kernel mode.
I didn&rsquo;t need an elaborate remote debugging setup for my purposes, so I
used <a href="http://technet.microsoft.com/en-us/sysinternals/bb897415">Sysinternals LiveKd</a>
to take a snapshot of my kernel and debug it.</p>

<p>My workflow was essentially as follows:</p>

<ol>
<li>Plugin Hang UI gets stuck</li>
<li>Attach a debugger (I use WinDbg) to <code>plugin-hang-ui.exe</code></li>
<li>Run LiveKd</li>
<li>Type <code>!thread -t &lt;tid&gt;</code> into the kernel debugger, where <code>&lt;tid&gt;</code> is the
thread ID that is hung in the user-mode WinDbg</li>
</ol>


<p>Every kernel-mode call stack that I examined on a hung thread usually ended up going through this code path:</p>

<pre><samp>
...
Child-SP          RetAddr           : Args to Child                                                           : Call Site
fffff880`0def3ec0 fffff800`0327c652 : fffffa80`079c43c0 fffffa80`079c43c0 00000000`00000000 fffffa80`00000008 : nt!KiSwapContext+0x7a
fffff880`0def4000 fffff800`0328da9f : fffffd54`0000000c fffffd54`000002a0 000002ac`00000000 00000804`fffffd54 : nt!KiCommitThreadWait+0x1d2
fffff880`0def4090 fffff800`03278a14 : 00000000`00000000 00000000`00000005 00000000`00000000 fffff800`03279600 : nt!KeWaitForSingleObject+0x19f
fffff880`0def4130 fffff800`03279691 : fffffa80`079c43c0 fffffa80`079c4410 00000000`00000000 00000000`00000000 : nt!KiSuspendThread+0x54
fffff880`0def4170 fffff800`0327c85d : fffffa80`079c43c0 00000000`00000000 fffff800`032789c0 00000000`00000000 : nt!KiDeliverApc+0x201
fffff880`0def41f0 fffff800`0328da9f : fffffa80`0a7510e0 fffff800`0327c26f fffffa80`00000000 fffff800`03402e80 : nt!KiCommitThreadWait+0x3dd
fffff880`0def4280 fffff960`0010d457 : fffff900`c2255200 00000000`0000000d 00000000`00000001 00000000`00000000 : nt!KeWaitForSingleObject+0x19f
fffff880`0def4320 fffff960`0010d4f1 : fffff880`0def0000 fffff900`c08e0e20 00000000`00000000 00000000`00000000 : win32k!xxxRealSleepThread+0x257
fffff880`0def43c0 fffff960`000c46d3 : 00000000`00000000 fffff900`c093ee90 00000000`00000200 00000000`00000046 : win32k!xxxSleepThread+0x59
fffff880`0def43f0 fffff960`0010c53e : fffff900`c093ee90 fffff900`c08e0e20 00000000`00000000 fffff900`c25724b0 : win32k!xxxInterSendMsgEx+0x112a
fffff880`0def4500 fffff960`000d8ccf : fffff900`c25724b0 fffff900`c25724b0 <mark>00000000`003c031a</mark> fffff900`c0800b90 : win32k!xxxSendMessageTimeout+0x1de
fffff880`0def45b0 fffff960`000dae0b : fffff960`00000006 fffff880`0def47c0 fffff960`00000000 fffff900`00000000 : win32k!xxxCalcValidRects+0x1a3
fffff880`0def46f0 fffff960`000dac3a : fffff900`00000001 fffff900`c08e0e20 fffff880`0def49b8 fffff900`00000000 : win32k!xxxEndDeferWindowPosEx+0x18f
fffff880`0def47b0 fffff960`000d6e09 : 00000000`00000000 00000000`00000001 fffff900`00000000 fffff800`00000000 : win32k!xxxSetWindowPos+0x156
fffff880`0def4830 fffff960`0007c66d : fffff900`00000000 fffff900`0004366c fffff900`00000000 fffff900`c209f410 : win32k!xxxActivateThisWindow+0x441
...
</samp></pre>


<p>The highlighted hexadecimal value above is a handle to a window with class
<code>MSCTFIME UI</code> (i.e. a Microsoft IME window) that was created by the main
UI thread in the hung Flash process. Despite my best efforts to try to
disconnect the Plugin Hang UI input queue from these threads, Windows is
insistent on sending a synchronous, inter-thread message to the IME window
on the hung Flash thread. This doesn&rsquo;t happen if we omit setting Firefox&rsquo;s
<code>HWND</code> as the Plugin Hang UI&rsquo;s owner window.</p>

<h3>Implications</h3>

<p>Now that the Plugin Hang UI specifies a <code>NULL</code> owner, Windows can no longer
guarantee that the Plugin Hang UI will always appear above the Firefox window
that was active at the time that the plugin hang occurred. Having said that,
our experiments have shown that Windows does not try to promote an unresponsive
window to the front of the Z-order.</p>

<p>In a multiple-window situation, Windows may move the other, inactive Firefox
windows ahead of the Plugin Hang UI in the Z-order, but the window that was
active when Firefox first hung does not move. I think that this is acceptable.
In fact, the same behavour would be observable if we had been able to specify
an owner.</p>

<p>If you&rsquo;re interested in helping to test this feature, please install Nightly
and try the repro from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=834127#c0">bug 834127</a>.
When the Plugin Hang UI fires, try to move around the Plugin Hang UI as well
as the other windows on your desktop, including Firefox. If the Z-order changes
differently from the way that I have observed here, please try to generate
some steps to reproduce, drop me a line (aklotz on <code>#perf</code> or MoCo email)
and let me know what&rsquo;s going on. Thanks!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/11/22/plugin-hang-user-interface-for-firefox/">Plugin Hang User Interface for Firefox</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-22T10:22:00-07:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2012/11/22/plugin-hang-user-interface-for-firefox/#disqus_thread"
             data-disqus-identifier="http://dblohm7.ca/blog/2012/11/22/plugin-hang-user-interface-for-firefox/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>My first significant project at Mozilla has been
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=805591">bug 805591</a>,
implementing a user interface to be displayed by Firefox when
an out-of-process plugin hangs. This is important because when NPAPI
plugins hang, they block the main thread in Firefox. When the main
thread is blocked, the Firefox user interface grinds to a halt.</p>

<p>The purpose of the Plugin Hang UI is twofold:</p>

<ul>
<li>To inform the user which plugin is responsible for the hang; and</li>
<li>Provide the user with an opportunity to terminate the plugin if he/she wishes.</li>
</ul>


<p>Currently this is feature is exclusive to Firefox Desktop on Windows.
When the Hang UI is invoked, you&rsquo;ll notice that Firefox has created
a new child process, plugin-hang-ui.exe. This child process will
display the Plugin Hang UI dialog box.</p>

<p><img src="http://dblohm7.ca/images/hangui.png"></p>

<p>My patch is currently under review, but the Plugin Hang UI is fully functional
in a <a href="http://ftp.mozilla.org/pub/mozilla.org/firefox/try-builds/aklotz@mozilla.com-f5d8fdf4f29a/try-win32/firefox-19.0a1.en-US.win32.installer.exe">try build</a>,
so please check it out and play with it!</p>

<h2>Changes to Preferences</h2>

<ul>
<li><p><code>dom.ipc.plugins.hangUITimeoutSecs</code>: This is the number of seconds
that Firefox waits for a hung plugin before displaying the Plugin Hang UI.
Setting this value to zero disables the Plugin Hang UI.</p></li>
<li><p><code>dom.ipc.plugins.timeoutSecs</code>: This pref is still used with the Hang UI,
but its semantics change a little bit. Once the Plugin Hang UI has been
displayed, Firefox will wait <code>dom.ipc.plugins.timeoutSecs</code> seconds before
terminating the plugin automatically, even if the user did not elect to
stop the plugin using the Hang UI. This is nearly identical to the way that
Firefox behaves without the Hang UI &ndash; the only difference is that now this
timeout period doesn&rsquo;t commence until the Hang UI is displayed.</p></li>
<li><p><code>dom.ipc.plugins.hangUIMinDisplaySecs</code>: This is the minimum number
of seconds that Firefox should display the Plugin Hang UI. If
<code>dom.ipc.plugins.timeoutSecs</code> is set to a value lower than this
pref, the Hang UI is disabled. The idea here is that, if
<code>dom.ipc.plugins.timeoutSecs</code> is only set to 5 seconds to begin with,
then the plugin will already have been auto terminated before the
user has half a chance to read the Plugin Hang UI.</p></li>
</ul>


<h2>Implementation Details</h2>

<p>There are a couple of interesting things that I&rsquo;d like to point out
relating to this patch.</p>

<p>Because the Plugin Hang UI is a child process, I needed to ensure that
its window always appears in front of the hung Firefox window. I decided
that I would have Firefox send its top-level <code>HWND</code> over to the child
process so that the Hang UI could specify that handle as the owner of its
top-level window. If you&rsquo;ve seen <a href="http://blogs.msdn.com/b/oldnewthing">Raymond Chen&rsquo;s</a>
<a href="http://channel9.msdn.com/Blogs/scobleizer/Raymond-Chen-PDC-05-Talk-Five-Things-Every-Win32-Programmer-Needs-to-Know">Five Things Every Win32 Programmer Needs to Know</a>,
then you&rsquo;ll know what is coming: Deadlock!</p>

<p>The problem is that the Hang UI window and the Firefox window are
created by different threads. When I set the owner relationship
between the Hang UI top-level window and the Firefox top-level window,
the window manager implicitly synchronizes both threads&#8217; input queues.
In the case of the Plugin Hang UI, this is a huge problem: Windows just
synchronized the Hang UI&rsquo;s input queue with a hung thread!</p>

<p>What&rsquo;s the solution, then? Think about it this way: the window manager
might have implicitly synchronized the two threads&#8217; input queues, but
there&rsquo;s no reason why we can&rsquo;t then <em>explicitly</em> desynchronize them!</p>

<p>Here&rsquo;s the first thing I do in the Plugin Hang UI&rsquo;s <code>WM_INITDIALOG</code> handler:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'>      <span class="c1">// Disentangle our input queue from the hung Firefox process</span>
</span><span class='line'>      <span class="n">AttachThreadInput</span><span class="p">(</span><span class="n">GetCurrentThreadId</span><span class="p">(),</span>
</span><span class='line'>                        <span class="n">GetWindowThreadProcessId</span><span class="p">(</span><span class="n">mParentWindow</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">),</span>
</span><span class='line'>                        <span class="n">FALSE</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Without this line, the Hang UI is at risk of deadlock. This is
especially true if the user attempts to send input to the Firefox
window underneath.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/07/28/interesting-win32-apis/">Interesting Win32 APIs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/12/waitmessage-considered-harmful/">WaitMessage Considered Harmful</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/03/attached-input-queues-on-firefox-for-windows/">Attached Input Queues on Firefox for Windows</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/31/asynchronous-plugin-initialization-nightly/">Asynchronous Plugin Initialization: Nightly</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/21/profile-unlocking-in-firefox-34-for-windows/">Profile Unlocking in Firefox 34 for Windows</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/dblohm7">@dblohm7</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'dblohm7',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/klotzy?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Aaron Klotz -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dblohm7';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
