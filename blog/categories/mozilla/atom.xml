<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Mozilla | Aaron Klotz at Mozilla]]></title>
  <link href="http://dblohm7.ca/blog/categories/mozilla/atom.xml" rel="self"/>
  <link href="http://dblohm7.ca/"/>
  <updated>2015-01-04T01:47:04-07:00</updated>
  <id>http://dblohm7.ca/</id>
  <author>
    <name><![CDATA[Aaron Klotz]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Asynchronous Plugin Initialization: Nightly]]></title>
    <link href="http://dblohm7.ca/blog/2014/12/31/asynchronous-plugin-initialization-nightly/"/>
    <updated>2014-12-31T12:00:00-07:00</updated>
    <id>http://dblohm7.ca/blog/2014/12/31/asynchronous-plugin-initialization-nightly</id>
    <content type="html"><![CDATA[<p>As of today&rsquo;s <a href="http://nightly.mozilla.org">Nightly</a>, Asynchronous Plugin
Initialization is available for testing. It is deactivated by default, so in
order to try it out you will need to navigate to <code>about:config</code> and toggle the
<code>dom.ipc.plugins.asyncInit</code> preference to <code>true</code>.</p>

<p>If you experience any problems, please <a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Core&amp;component=Plug-ins&amp;blocked=1116806">file a bug</a> that blocks <a title="Let Asynchronous Plugin Initialization ride the train" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1116806">bug 1116806</a>.</p>

<p>Happy New Year!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Profile Unlocking in Firefox 34 for Windows]]></title>
    <link href="http://dblohm7.ca/blog/2014/08/21/profile-unlocking-in-firefox-34-for-windows/"/>
    <updated>2014-08-21T10:00:00-06:00</updated>
    <id>http://dblohm7.ca/blog/2014/08/21/profile-unlocking-in-firefox-34-for-windows</id>
    <content type="html"><![CDATA[<p>Today&rsquo;s <a href="http://nightly.mozilla.org">Nightly 34</a> build includes the work I did
for <a title="Need win32 implementation of nsIProfileUnlocker" href="https://bugzilla.mozilla.org/show_bug.cgi?id=286355">bug 286355</a>: a profile unlocker for our Windows users. This should be very
helpful to those users whose workflow is interrupted by a Firefox instance that
cannot start because a previous Firefox instance has not finished shutting down.</p>

<p>Firefox 34 users running Windows Vista or newer will now be presented with this
dialog box:</p>

<p><a href="href="http://dblohm7.ca/images/profile-unlocker.png">http://dblohm7.ca/images/profile-unlocker.png</a>"><img class="<a" src="href="http://dblohm7.ca/images/profile-unlocker.png">http://dblohm7.ca/images/profile-unlocker.png</a>"></a></p>

<p>Clicking &ldquo;Close Firefox&rdquo; will terminate that previous instance and proceed
with starting your new Firefox instance.</p>

<p>Unfortunately this feature is not available to Windows XP users. To support this
feature on Windows XP we would need to call undocumented API functions. I
prefer to avoid calling undocumented APIs when writing production software due
to the potential stability and compatibility issues that can arise from doing
so.</p>

<p>While this feature adds some convenience to an otherwise annoying issue, please
be assured that the Desktop Performance Team will continue to investigate and
fix the root causes of long shutdowns so that a profile unlocker hopefully
becomes unnecessary.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Diffusion of Responsibility]]></title>
    <link href="http://dblohm7.ca/blog/2014/08/14/diffusion-of-responsibility/"/>
    <updated>2014-08-14T14:00:00-06:00</updated>
    <id>http://dblohm7.ca/blog/2014/08/14/diffusion-of-responsibility</id>
    <content type="html"><![CDATA[<p>Something that I&rsquo;ve been noticing on numerous social media and discussion forum
sites is that whenever Firefox comes up, inevitably there are comments in those
threads about Firefox performance. Given my role at Mozilla, these comments are
of particular interest to me.</p>

<p>The reaction to roc&rsquo;s <a href="http://robert.ocallahan.org/2014/08/choose-firefox-now-or-later-you-wont.html">recent blog post</a>
has motivated me enough to respond to a specific subset of comments. These
comments all exhibit a certain pattern: their authors are experiencing problems
with Firefox, they are very dissatisfied, but they are not discussing them in a
way that is actionable by Mozilla.</p>

<h2>How Mozilla Finds Problems</h2>

<p>Mozilla encourages our contributors to run prerelease versions of Firefox,
especially <a href="http://nightly.mozilla.org">Nightly</a> builds. This allows us to do
some good old-fashioned dogfooding during the development of a Firefox release.</p>

<p>We also have many tools that run as part of our continuous integration
infrastructure. Valgrind, Address Sanitizer, Leak Sanitizer, reference count
tracking, deadlock detection, assertions, Talos performance tests, and xperf are
some of the various tools that we apply to our builds. I do not claim that this
list is exhaustive! :&ndash;)</p>

<p>We use numerous technologies to discover problems that occur while running on
our users' computers. We have a crash reporter that (with the user&rsquo;s consent)
reports <a href="https://crash-stats.mozilla.com/home/products/Firefox">data</a> about the
crash. We have Firefox Health Report and <a href="http://telemetry.mozilla.org">Telemetry</a>
that, when consented to, send us useful information for discovering problems.</p>

<p>Our ability to analyze crash report/FHR/telemetry data is limited to those users
who consent to share it with us. As much as I am proud of the fact that we
respect the privacy of our users, this means that we only receive data from a
fraction of them; many users who are experiencing problems are not included in
this data.</p>

<p>Despite the fact that we have all of these wonderful tools to help us deliver
quality releases, the fact is that they cannot exhaustively catch every possible
bug that is encountered out in the wild. There are too many combinations of
extensions and configurations out there to possibly allow us to catch
everything before release.</p>

<p>That&rsquo;s where you, our users, come in!</p>

<h2>If You See Something, Report It!</h2>

<p>Reddit, Hacker News, Slashdot and other similar sites are fantastic for ranting.
I should know &mdash; I do it with the best of them! Having said that, they are also
terrible for the purposes of bug reporting!</p>

<p>As users it&rsquo;s easy for us to assume that somebody else will encounter our
problems and report them. Unfortunately that is not always the case, especially
with a browser that is as configurable as Firefox.</p>

<h3>Reporting Bugs</h3>

<p>If you are experiencing a bug, the best way to ensure that something can be done
about your bug is to <a href="https://bugzilla.mozilla.org/enter_bug.cgi?format=guided">report it</a>
in Bugzilla. This might seem a little bit intimidating for somebody who is new
to bug reporting, but I assure you, Mozillians are really nice! As long as you
follow the <a href="https://bugzilla.mozilla.org/page.cgi?id=etiquette.html">etiquette guidelines</a>,
you&rsquo;ll be fine! One suggestion though: try to follow our
<a href="https://developer.mozilla.org/en-US/docs/Mozilla/QA/Bug_writing_guidelines">bug writing guidelines</a>.
Doing so will maximize the likelihood of a contributor being able to reproduce
your problem. In addition to these suggestions for bug filing, I also suggest
including certain types of data for specific types of problems:</p>

<h3>Reporting a Bug for High Memory Usage</h3>

<p>If you&rsquo;re experiencing problems with Firefox&rsquo;s memory use, open a tab, and
point your browser to <code>about:memory</code>. This nifty feature provides a breakdown
of Firefox memory consumption. Save that report and attach it to the bug that
you&rsquo;ve filed.</p>

<h3>Reporting a Bug for Slowness or Heavy CPU Usage</h3>

<p>If you want report a problem with Firefox being slow and/or mysteriously
consuming large amounts of CPU time, the best way to help us is
is to include data that has been generated by the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Performance/Profiling_with_the_Built-in_Profiler">Gecko Profiler</a>.
[<em>This data is referred to as a &ldquo;profile,&rdquo; but please do not confuse it with the
user profile that stores your settings and browser history &mdash; they are different
things with the same name.</em>] This tool tracks how Firefox uses your CPU over
time. If you are able to attach a profile that was taken during a period of time
where Firefox was running poorly, it will help us understand what exactly Firefox
was doing. Unfortunately this is tool requires a bit of technical savvy, but
attaching the URL of an uploaded profile to your performance bug can be very helpful.</p>

<h3>Reporting a Bug for a Persistent, Reproducable Crash</h3>

<p>As you can see in our <a href="https://crash-stats.mozilla.com/home/products/Firefox">crash report data</a>,
crashes reported to Mozilla are ranked by frequency. As you might expect, this
implies that it&rsquo;s often the squeaky wheels that get the grease.</p>

<p>If you have an easily reproducable crash and you are sending your reports to
Mozilla, you can help us by pointing Firefox to <code>about:crashes</code>. This page lists
all of the crash reports that have been generated on your computer. If the crash
that you are experiencing isn&rsquo;t on our list of top crashers, you can still help
us to fix it: filing a bug that includes multiple crash report URLs from your
<code>about:crashes</code> screen will help tremendously.</p>

<h3>Reporting a Bug for a Website that Looks Wrong in Firefox</h3>

<p>I&rsquo;d suggest reporting your problem over at <a href="http://webcompat.com">webcompat.com</a>.
Volunteers will review your report and determine whether your problem is caused
by the website or by Firefox, and file a bug with the appropriate entity.</p>

<h3>I have a problem that isn&rsquo;t listed here. What should I do?</h3>

<p>Send us <a href="https://input.mozilla.org/en-US/feedback">feedback</a>!</p>

<h2>In Conclusion</h2>

<p>If there is one idea that you can take away from this post (a TL;DR, if you will),
it is this: <em>Mozilla cannot fix 100% of the bugs that we do not know about.</em></p>

<p>Taking an active role in the Mozilla community by reporting your issues through
the proper channels is the best way to ensure that your problems can be fixed.</p>

<p><strong>EDIT:</strong> To be clear: What I am suggesting is that users who are enthusiastic
enough to post a comment to Hacker News (for example) should also be savvy
enough to be able to file a proper bug report. Please do not misconstrue this
post as a demand that novice users start filing bugs.</p>

<p><strong>EDIT August 15, 2014:</strong> Nick Nethercote just <a href="https://blog.mozilla.org/nnethercote/2014/08/15/the-story-of-a-tricky-bug/">blogged</a>
about a tricky memory bug that couldn&rsquo;t have been diagnosed without the help of
a Redditor whose complaint we steered to Bugzilla.</p>

<p><strong>EDIT August 23, 2014:</strong> Wow, this has blown up. More edits to update this post
with additional information in repose to some of the questions posted in the
comments. Thanks for reading!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Asynchronous Plugin Initialization: An Introduction]]></title>
    <link href="http://dblohm7.ca/blog/2014/06/17/asynchronous-plugin-initialization-an-introduction/"/>
    <updated>2014-06-17T02:30:00-06:00</updated>
    <id>http://dblohm7.ca/blog/2014/06/17/asynchronous-plugin-initialization-an-introduction</id>
    <content type="html"><![CDATA[<p>I have spent a lot of time this quarter working on <a title="Asynchronous Initialization of Out-of-process Plugins" href="https://bugzilla.mozilla.org/show_bug.cgi?id=998863">bug 998863</a>, &ldquo;Asynchronous
Initialization of Out-of-process Plugins.&rdquo; While the bug summary is fairly self
explanatory, I would like to provide some more details about why I am doing this
and what kind of work it entails. I would also like to wrap up the post with an
early demonstration of this feature and present some profiles to illustrate the
potential performance improvement.</p>

<h2>Rationale</h2>

<p>The reason that I am undertaking this project is because NPAPI plugin startup
is our most frequent cause of jank. In fact, at the time of this writing, our
<a href="http://telemetry.mozilla.org/chromehangs/">Chrome Hangs telemetry</a> is showing
that 4 out of our top 10 most frequent offending call stacks are related to
plugin initialization and instantiation. Furthermore, creating the
plugin-container.exe child process is the #1 most frequent chrome hang offender
(Note that our Chrome Hang telemetry consists entirely of Windows builds, where
process creation is quite expensive).</p>

<h2>A High-level Breakdown of NPAPI Initialization and Instantiation</h2>

<p>The typical steps involved can be broken down as follows:</p>

<ol>
<li>Launch the <code>plugin-container</code> process;</li>
<li>Call <code>NP_Initialize</code> to load the plugin;</li>
<li>Create instances by calling <code>NPP_New</code>;</li>
<li>Call <code>NPP_NewStream</code> for instances that load stream data;</li>
<li>If an instance is scriptable, call <code>NPP_GetValue</code> to obtain information
about the plugin&rsquo;s scriptable object.</li>
</ol>


<p>The patch that I am working on modifies steps 1 through 4 to run asynchronously.
Step 5 is a special case &mdash; we asynchronously return a proxy object, but if a
synchronous JS method is called on that object, we must wait for the plugin to
initialize (if it has not yet done so). My hope is that if we have to call a
synchronous JS method on the proxy object, plugin initialization will be far
enough along that the wait will be minimal.</p>

<h2>A Brief Demonstration</h2>

<p>The following video compares two locally-built Nightlies that are identical
except for the asynchronous initialization patch. After loading the browser
with a page containing several embedded Flash objects, we can profile and
observe the effects of this patch.</p>

<iframe width="420" height="315" src="//www.youtube-nocookie.com/embed/HZ8Z2Drv8uI?rel-0" frameborder="0" allowfullscreen></iframe>


<p>Here are links to some profiles:</p>

<p><a href="http://people.mozilla.org/~bgirard/cleopatra/#report=a5a96119742fa75b64ab7d12566eede68468ef3c">Synchronous Plugin Initialization</a></p>

<p><a href="http://people.mozilla.org/~bgirard/cleopatra/#report=282e372d3357316307c182607f26c00f4f41011e">Asynchronous Plugin Initialization</a></p>

<h2>Disclaimer</h2>

<p>This patch requires some further work on scripting and stabilization. The
information in this post is subject to change. :&ndash;)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Detecting Main Thread I/O with SPS]]></title>
    <link href="http://dblohm7.ca/blog/2013/06/12/detecting-main-thread-i-slash-o-with-sps/"/>
    <updated>2013-06-12T18:00:00-06:00</updated>
    <id>http://dblohm7.ca/blog/2013/06/12/detecting-main-thread-i-slash-o-with-sps</id>
    <content type="html"><![CDATA[<p>In <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=867762">bug 867762</a> I am landing I/O
interpose facilities for SPS. This feature will allow main thread I/O to be
displayed in the profiler UI.</p>

<p>There are a few components to this patch. Classes that implement the
<code>IOInterposerModule</code> interface are responsible for hooking into an arbitrary I/O
facility and calling into <code>IOInterposer</code> with those events.</p>

<p>The <code>IOInterposer</code> receives those events and then dispatches them to any registered
observers. For the purposes of SPS there is only one observer,
<code>ProfilerIOInterposeObserver</code>, however I wrote this keeping in mind that we
may eventually want to use the I/O interpose facilities for other purposes (such
as shutdown write poisioning).</p>

<p>For bug 867762 I have implemented two modules. <code>NSPRInterposer</code> hooks into NSPR
file I/O and generates events whenever a <code>PR_Read</code>, <code>PR_Write</code>, or <code>PR_Sync</code> occurs.
The second module, <code>SQLiteInterposer</code>, leverages the SQLite VFS that we use for
telemetry to tap into reads, writes, and fsyncs generated by SQLite. In the future
we expect to expand this into several additional modules. Some ideas include a module
that uses Event Tracing for Windows to read events from the Windows kernel and a
module that interposes calls to <code>read</code>, <code>write</code>, and <code>fsync</code> on Linux.</p>

<p>On the observer side of things, for now we simply insert a marker into the profiler
timeline whenever main thread I/O is reported. Here is a sample screenshot of the
markers in action (the pink stuff for readers who are unfamiliar with SPS markers):</p>

<p><a href="href="http://dblohm7.ca/images/iomarkers.png">http://dblohm7.ca/images/iomarkers.png</a>"><img class="<a" src="href="http://dblohm7.ca/images/iomarkers.png">http://dblohm7.ca/images/iomarkers.png</a>"></a></p>

<p>In <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=867757">bug 867757</a> (under review)
this will become more sophisticated, as SPS will immediately sample the callstack of
the thread whose I/O has been intercepted. This annotated stack will be inserted
directly into the timeline.</p>

<p>There will need to be some UI changes for this to be presented in a reasonable way,
but with both existing patches applied the data is already useful. By firing up
Cleopatra and filtering on either <code>NSPRInterposer</code> or <code>SQLiteInterposer</code>, you can
isolate and view the main thread I/O stacks:</p>

<p><a href="href="http://dblohm7.ca/images/iofilteredstacks.png">http://dblohm7.ca/images/iofilteredstacks.png</a>"><img class="<a" src="href="http://dblohm7.ca/images/iofilteredstacks.png">http://dblohm7.ca/images/iofilteredstacks.png</a>"></a></p>

<p>Hopefully these patches will prove to be beneficial to our efforts to eliminate
main thread I/O.</p>
]]></content>
  </entry>
  
</feed>
