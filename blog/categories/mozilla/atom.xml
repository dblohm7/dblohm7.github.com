<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Mozilla | Aaron Klotz at Mozilla]]></title>
  <link href="http://dblohm7.ca/blog/categories/mozilla/atom.xml" rel="self"/>
  <link href="http://dblohm7.ca/"/>
  <updated>2015-03-04T18:05:17-07:00</updated>
  <id>http://dblohm7.ca/</id>
  <author>
    <name><![CDATA[Aaron Klotz]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Attached Input Queues on Firefox for Windows]]></title>
    <link href="http://dblohm7.ca/blog/2015/03/03/attached-input-queues-on-firefox-for-windows/"/>
    <updated>2015-03-03T17:28:06-07:00</updated>
    <id>http://dblohm7.ca/blog/2015/03/03/attached-input-queues-on-firefox-for-windows</id>
    <content type="html"><![CDATA[<p>I&rsquo;ve <a href="http://dblohm7.ca/blog/2012/11/22/plugin-hang-user-interface-for-firefox/">previously</a> <a href="http://dblohm7.ca/blog/2013/02/15/plugin-hang-ui-on-aurora/">blogged</a>
indirectly about attached input queues, but today I want to address the issue directly. What once was a nuisance in the realm of plugin hangs has grown into a more
serious problem in the land of OMTC and e10s.</p>

<p>As a brief recap for those who are not very familiar with this problem: imagine two windows, each on their own separate threads, forming a parent-child relationship
with each other. When this situation arises, Windows implicitly attaches together and synchronizes their input queues, putting each thread at the mercy of the other
attached threads' ability to pump messages. If one thread does something bad in its message pump, any other threads that are attached to it are likely to be affected as well.</p>

<p>One of the biggest annoyances when it comes to knowledge about which threads are affected, is that we are essentially flying blind. There is no
way to query Windows for information about attached input queues. This is unfortunate, as it would be really nice to obtain some specific knowledge to allow us to
analyze the state of Firefox threads' input queues so that we can mitigate the problem.</p>

<p>I had previously been working on a personal side project to make this possible, but in light of recent developments (and a <a href="https://twitter.com/nsIAnswers/status/565883284748795905">tweet from bsmedberg</a>),
I decided to bring this investigation under the umbrella of my full-time job. I&rsquo;m pleased to announce that I&rsquo;ve finished the first cut of a utility that I call
the Input Queue Visualizer, or <code>iqvis</code>.</p>

<p><code>iqvis</code> consists of two components, one of which is a kernel-mode driver. This driver exposes input queue attachment data to user mode. The <code>iqvis</code> user-mode
executable is the client that queries the driver and outputs the results. In the next section I&rsquo;m going to discuss the inner workings of <code>iqvis</code>. Following that, I&rsquo;ll
discuss the <a href="#results">results</a> of running <code>iqvis</code> on an instance of Firefox.</p>

<h2><a name="internals"></a>Input Queue Visualizer Internals</h2>

<p>First of all, let&rsquo;s start off with this caveat: <strong>Nearly everything that this driver does involves undocumented APIs and data structures</strong>. Because of this, <code>iqvis</code>
does some things that you should never do in production software.</p>

<p>One of the big consequences of using undocumented information is that <code>iqvis</code> requires pointers to very specific locations
in kernel memory to accomplish things. These pointers will change every time that Windows is updated. To mitigate this, I kind of cheated: it turns out that
debugging symbols exist for all of the locations that <code>iqvis</code> needs to access! I wrote the <code>iqvis</code> client to invoke the <code>dbghelp</code> engine to extract the pointers that
I need from Windows symbols and send those values as the input to the <code>DeviceIoControl</code> call that triggers the data collection. Passing pointers from user mode to be
accessed in kernel mode is a very dangerous thing to do (and again, I would never do it in production software), but it is damn convenient for <code>iqvis</code>!</p>

<p>Another issue is that these undocumented details change between Windows versions. The initial version of <code>iqvis</code> works on 64-bit Windows 8.1, but different code is required
for other major releases, such as Windows 7. The <code>iqvis</code> driver theoretically will work on Windows 7 but I need to make a few bug fixes for that case.</p>

<p>So, getting those details out of the way, we can address the crux of the problem: we need to query input queue attachment information from <code>win32k.sys</code>, which is the
driver that implements USER and GDI system calls on Windows NT systems.</p>

<p>In particular, the window manager maintains a linked list that describes thread attachment info as a triple that points to the &ldquo;from&rdquo; thread, the &ldquo;to&rdquo; thread, and a count.
The count is necessary because the same two threads may be attached to each other multiple times. The <code>iqvis</code> driver walks this linked list in a thread-safe way to obtain
the attachment data, and then copies it to the output buffer for the <code>DeviceIoControl</code> request.</p>

<p>Since <code>iqvis</code> involves a device driver, and since I have not digitally signed that device driver, one can&rsquo;t just run <code>iqvis</code> and call it a day. This program won&rsquo;t work
unless the computer was either booted with kernel debugging enabled, or it was booted with driver signing temporarily disabled.</p>

<h2><a name="results"></a>Running <code>iqvis</code> against Firefox</h2>

<p>Today I ran <code>iqvis</code> using today&rsquo;s Nightly 39 as well as the lastest release of Flash. I also tried it with Flash Protected Mode both disabled and enabled.
(Note that these examples used an older version of <code>iqvis</code> that outputs thread IDs in hexadecimal. The current version uses decimal for its output.)</p>

<h3>Protected Mode Disabled</h3>

<pre><samp>FromTID ToTID Count
ac8 df4 1
</samp></pre>


<p>Looking up the thread IDs:</p>

<ul>
<li><code>df4</code> is the Firefox main thread;</li>
<li><code>ac8</code> is the plugin-container main thread.</li>
</ul>


<p>I think that the output from this case is pretty much what I was expecting to see. The protected mode case, however, is more interesting.</p>

<h3>Protected Mode Enabled</h3>

<pre><samp>FromTID ToTID Count
f8c dbc 1
794 f8c 3
</samp></pre>


<p>Looking up the thread IDs:</p>

<ul>
<li><code>dbc</code> is the Firefox main thread;</li>
<li><code>f8c</code> is the plugin-container main thread;</li>
<li><code>794</code> is the Flash sandbox main thread.</li>
</ul>


<p>Notice how Flash is attached to plugin-container, which is then attached to Firefox. Notice that transitively the Flash sandbox is effectively attached to Firefox,
confirming previous hypotheses that I&rsquo;ve discussed with colleagues in the past.</p>

<p>Also notice how the Flash sandbox attachment to plugin-container has a count of 3!</p>

<h2>In Conclusion</h2>

<p>In my opinion, my Input Queue Visualizer has already yielded some very interesting data. Hopefully this will help us to troubleshoot our issues in the future. Oh,
and the code is up on <a href="https://github.com/dblohm7/iqvis">GitHub</a>! It&rsquo;s poorly documented at the moment, but just remember to only try running it on 64-bit Windows
8.1 for the time being!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Asynchronous Plugin Initialization: Nightly]]></title>
    <link href="http://dblohm7.ca/blog/2014/12/31/asynchronous-plugin-initialization-nightly/"/>
    <updated>2014-12-31T12:00:00-07:00</updated>
    <id>http://dblohm7.ca/blog/2014/12/31/asynchronous-plugin-initialization-nightly</id>
    <content type="html"><![CDATA[<p>As of today&rsquo;s <a href="http://nightly.mozilla.org">Nightly</a>, Asynchronous Plugin
Initialization is available for testing. It is deactivated by default, so in
order to try it out you will need to navigate to <code>about:config</code> and toggle the
<code>dom.ipc.plugins.asyncInit</code> preference to <code>true</code>.</p>

<p>If you experience any problems, please <a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Core&amp;component=Plug-ins&amp;blocked=1116806">file a bug</a> that blocks <a title="Let Asynchronous Plugin Initialization ride the train" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1116806">bug 1116806</a>.</p>

<p>Happy New Year!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Profile Unlocking in Firefox 34 for Windows]]></title>
    <link href="http://dblohm7.ca/blog/2014/08/21/profile-unlocking-in-firefox-34-for-windows/"/>
    <updated>2014-08-21T10:00:00-06:00</updated>
    <id>http://dblohm7.ca/blog/2014/08/21/profile-unlocking-in-firefox-34-for-windows</id>
    <content type="html"><![CDATA[<p>Today&rsquo;s <a href="http://nightly.mozilla.org">Nightly 34</a> build includes the work I did
for <a title="Need win32 implementation of nsIProfileUnlocker" href="https://bugzilla.mozilla.org/show_bug.cgi?id=286355">bug 286355</a>: a profile unlocker for our Windows users. This should be very
helpful to those users whose workflow is interrupted by a Firefox instance that
cannot start because a previous Firefox instance has not finished shutting down.</p>

<p>Firefox 34 users running Windows Vista or newer will now be presented with this
dialog box:</p>

<p><a href="href="http://dblohm7.ca/images/profile-unlocker.png">http://dblohm7.ca/images/profile-unlocker.png</a>"><img class="<a" src="href="http://dblohm7.ca/images/profile-unlocker.png">http://dblohm7.ca/images/profile-unlocker.png</a>"></a></p>

<p>Clicking &ldquo;Close Firefox&rdquo; will terminate that previous instance and proceed
with starting your new Firefox instance.</p>

<p>Unfortunately this feature is not available to Windows XP users. To support this
feature on Windows XP we would need to call undocumented API functions. I
prefer to avoid calling undocumented APIs when writing production software due
to the potential stability and compatibility issues that can arise from doing
so.</p>

<p>While this feature adds some convenience to an otherwise annoying issue, please
be assured that the Desktop Performance Team will continue to investigate and
fix the root causes of long shutdowns so that a profile unlocker hopefully
becomes unnecessary.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Diffusion of Responsibility]]></title>
    <link href="http://dblohm7.ca/blog/2014/08/14/diffusion-of-responsibility/"/>
    <updated>2014-08-14T14:00:00-06:00</updated>
    <id>http://dblohm7.ca/blog/2014/08/14/diffusion-of-responsibility</id>
    <content type="html"><![CDATA[<p>Something that I&rsquo;ve been noticing on numerous social media and discussion forum
sites is that whenever Firefox comes up, inevitably there are comments in those
threads about Firefox performance. Given my role at Mozilla, these comments are
of particular interest to me.</p>

<p>The reaction to roc&rsquo;s <a href="http://robert.ocallahan.org/2014/08/choose-firefox-now-or-later-you-wont.html">recent blog post</a>
has motivated me enough to respond to a specific subset of comments. These
comments all exhibit a certain pattern: their authors are experiencing problems
with Firefox, they are very dissatisfied, but they are not discussing them in a
way that is actionable by Mozilla.</p>

<h2>How Mozilla Finds Problems</h2>

<p>Mozilla encourages our contributors to run prerelease versions of Firefox,
especially <a href="http://nightly.mozilla.org">Nightly</a> builds. This allows us to do
some good old-fashioned dogfooding during the development of a Firefox release.</p>

<p>We also have many tools that run as part of our continuous integration
infrastructure. Valgrind, Address Sanitizer, Leak Sanitizer, reference count
tracking, deadlock detection, assertions, Talos performance tests, and xperf are
some of the various tools that we apply to our builds. I do not claim that this
list is exhaustive! :&ndash;)</p>

<p>We use numerous technologies to discover problems that occur while running on
our users' computers. We have a crash reporter that (with the user&rsquo;s consent)
reports <a href="https://crash-stats.mozilla.com/home/products/Firefox">data</a> about the
crash. We have Firefox Health Report and <a href="http://telemetry.mozilla.org">Telemetry</a>
that, when consented to, send us useful information for discovering problems.</p>

<p>Our ability to analyze crash report/FHR/telemetry data is limited to those users
who consent to share it with us. As much as I am proud of the fact that we
respect the privacy of our users, this means that we only receive data from a
fraction of them; many users who are experiencing problems are not included in
this data.</p>

<p>Despite the fact that we have all of these wonderful tools to help us deliver
quality releases, the fact is that they cannot exhaustively catch every possible
bug that is encountered out in the wild. There are too many combinations of
extensions and configurations out there to possibly allow us to catch
everything before release.</p>

<p>That&rsquo;s where you, our users, come in!</p>

<h2>If You See Something, Report It!</h2>

<p>Reddit, Hacker News, Slashdot and other similar sites are fantastic for ranting.
I should know &mdash; I do it with the best of them! Having said that, they are also
terrible for the purposes of bug reporting!</p>

<p>As users it&rsquo;s easy for us to assume that somebody else will encounter our
problems and report them. Unfortunately that is not always the case, especially
with a browser that is as configurable as Firefox.</p>

<h3>Reporting Bugs</h3>

<p>If you are experiencing a bug, the best way to ensure that something can be done
about your bug is to <a href="https://bugzilla.mozilla.org/enter_bug.cgi?format=guided">report it</a>
in Bugzilla. This might seem a little bit intimidating for somebody who is new
to bug reporting, but I assure you, Mozillians are really nice! As long as you
follow the <a href="https://bugzilla.mozilla.org/page.cgi?id=etiquette.html">etiquette guidelines</a>,
you&rsquo;ll be fine! One suggestion though: try to follow our
<a href="https://developer.mozilla.org/en-US/docs/Mozilla/QA/Bug_writing_guidelines">bug writing guidelines</a>.
Doing so will maximize the likelihood of a contributor being able to reproduce
your problem. In addition to these suggestions for bug filing, I also suggest
including certain types of data for specific types of problems:</p>

<h3>Reporting a Bug for High Memory Usage</h3>

<p>If you&rsquo;re experiencing problems with Firefox&rsquo;s memory use, open a tab, and
point your browser to <code>about:memory</code>. This nifty feature provides a breakdown
of Firefox memory consumption. Save that report and attach it to the bug that
you&rsquo;ve filed.</p>

<h3>Reporting a Bug for Slowness or Heavy CPU Usage</h3>

<p>If you want report a problem with Firefox being slow and/or mysteriously
consuming large amounts of CPU time, the best way to help us is
is to include data that has been generated by the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Performance/Profiling_with_the_Built-in_Profiler">Gecko Profiler</a>.
[<em>This data is referred to as a &ldquo;profile,&rdquo; but please do not confuse it with the
user profile that stores your settings and browser history &mdash; they are different
things with the same name.</em>] This tool tracks how Firefox uses your CPU over
time. If you are able to attach a profile that was taken during a period of time
where Firefox was running poorly, it will help us understand what exactly Firefox
was doing. Unfortunately this is tool requires a bit of technical savvy, but
attaching the URL of an uploaded profile to your performance bug can be very helpful.</p>

<h3>Reporting a Bug for a Persistent, Reproducable Crash</h3>

<p>As you can see in our <a href="https://crash-stats.mozilla.com/home/products/Firefox">crash report data</a>,
crashes reported to Mozilla are ranked by frequency. As you might expect, this
implies that it&rsquo;s often the squeaky wheels that get the grease.</p>

<p>If you have an easily reproducable crash and you are sending your reports to
Mozilla, you can help us by pointing Firefox to <code>about:crashes</code>. This page lists
all of the crash reports that have been generated on your computer. If the crash
that you are experiencing isn&rsquo;t on our list of top crashers, you can still help
us to fix it: filing a bug that includes multiple crash report URLs from your
<code>about:crashes</code> screen will help tremendously.</p>

<h3>Reporting a Bug for a Website that Looks Wrong in Firefox</h3>

<p>I&rsquo;d suggest reporting your problem over at <a href="http://webcompat.com">webcompat.com</a>.
Volunteers will review your report and determine whether your problem is caused
by the website or by Firefox, and file a bug with the appropriate entity.</p>

<h3>I have a problem that isn&rsquo;t listed here. What should I do?</h3>

<p>Send us <a href="https://input.mozilla.org/en-US/feedback">feedback</a>!</p>

<h2>In Conclusion</h2>

<p>If there is one idea that you can take away from this post (a TL;DR, if you will),
it is this: <em>Mozilla cannot fix 100% of the bugs that we do not know about.</em></p>

<p>Taking an active role in the Mozilla community by reporting your issues through
the proper channels is the best way to ensure that your problems can be fixed.</p>

<p><strong>EDIT:</strong> To be clear: What I am suggesting is that users who are enthusiastic
enough to post a comment to Hacker News (for example) should also be savvy
enough to be able to file a proper bug report. Please do not misconstrue this
post as a demand that novice users start filing bugs.</p>

<p><strong>EDIT August 15, 2014:</strong> Nick Nethercote just <a href="https://blog.mozilla.org/nnethercote/2014/08/15/the-story-of-a-tricky-bug/">blogged</a>
about a tricky memory bug that couldn&rsquo;t have been diagnosed without the help of
a Redditor whose complaint we steered to Bugzilla.</p>

<p><strong>EDIT August 23, 2014:</strong> Wow, this has blown up. More edits to update this post
with additional information in repose to some of the questions posted in the
comments. Thanks for reading!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Asynchronous Plugin Initialization: An Introduction]]></title>
    <link href="http://dblohm7.ca/blog/2014/06/17/asynchronous-plugin-initialization-an-introduction/"/>
    <updated>2014-06-17T02:30:00-06:00</updated>
    <id>http://dblohm7.ca/blog/2014/06/17/asynchronous-plugin-initialization-an-introduction</id>
    <content type="html"><![CDATA[<p>I have spent a lot of time this quarter working on <a title="Asynchronous Initialization of Out-of-process Plugins" href="https://bugzilla.mozilla.org/show_bug.cgi?id=998863">bug 998863</a>, &ldquo;Asynchronous
Initialization of Out-of-process Plugins.&rdquo; While the bug summary is fairly self
explanatory, I would like to provide some more details about why I am doing this
and what kind of work it entails. I would also like to wrap up the post with an
early demonstration of this feature and present some profiles to illustrate the
potential performance improvement.</p>

<h2>Rationale</h2>

<p>The reason that I am undertaking this project is because NPAPI plugin startup
is our most frequent cause of jank. In fact, at the time of this writing, our
<a href="http://telemetry.mozilla.org/chromehangs/">Chrome Hangs telemetry</a> is showing
that 4 out of our top 10 most frequent offending call stacks are related to
plugin initialization and instantiation. Furthermore, creating the
plugin-container.exe child process is the #1 most frequent chrome hang offender
(Note that our Chrome Hang telemetry consists entirely of Windows builds, where
process creation is quite expensive).</p>

<h2>A High-level Breakdown of NPAPI Initialization and Instantiation</h2>

<p>The typical steps involved can be broken down as follows:</p>

<ol>
<li>Launch the <code>plugin-container</code> process;</li>
<li>Call <code>NP_Initialize</code> to load the plugin;</li>
<li>Create instances by calling <code>NPP_New</code>;</li>
<li>Call <code>NPP_NewStream</code> for instances that load stream data;</li>
<li>If an instance is scriptable, call <code>NPP_GetValue</code> to obtain information
about the plugin&rsquo;s scriptable object.</li>
</ol>


<p>The patch that I am working on modifies steps 1 through 4 to run asynchronously.
Step 5 is a special case &mdash; we asynchronously return a proxy object, but if a
synchronous JS method is called on that object, we must wait for the plugin to
initialize (if it has not yet done so). My hope is that if we have to call a
synchronous JS method on the proxy object, plugin initialization will be far
enough along that the wait will be minimal.</p>

<h2>A Brief Demonstration</h2>

<p>The following video compares two locally-built Nightlies that are identical
except for the asynchronous initialization patch. After loading the browser
with a page containing several embedded Flash objects, we can profile and
observe the effects of this patch.</p>

<iframe width="420" height="315" src="//www.youtube-nocookie.com/embed/HZ8Z2Drv8uI?rel-0" frameborder="0" allowfullscreen></iframe>


<p>Here are links to some profiles:</p>

<p><a href="http://people.mozilla.org/~bgirard/cleopatra/#report=a5a96119742fa75b64ab7d12566eede68468ef3c">Synchronous Plugin Initialization</a></p>

<p><a href="http://people.mozilla.org/~bgirard/cleopatra/#report=282e372d3357316307c182607f26c00f4f41011e">Asynchronous Plugin Initialization</a></p>

<h2>Disclaimer</h2>

<p>This patch requires some further work on scripting and stabilization. The
information in this post is subject to change. :&ndash;)</p>
]]></content>
  </entry>
  
</feed>
